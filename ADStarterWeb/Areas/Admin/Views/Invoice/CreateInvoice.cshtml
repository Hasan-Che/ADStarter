@{
    ViewData["Title"] = "Billing - Create Invoice";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@model IEnumerable<ADStarter.Models.Child>
@section Scripts {
    <script>
        function calculateFee(schedule) {
            var sessionDate = new Date(schedule.session_datetime);
            var isWeekend = sessionDate.getDay() === 4 || sessionDate.getDay() === 5;
                
            return schedule.Program ? (isWeekend ? schedule.Program.prog_WeekendPrice : schedule.prog_WeekdayPrice) : 0;
        }

        $(document).ready(function() {
            $('#childSelect').change(function() {
                var childId = $(this).val();
                if (childId) {
                    $.getJSON('@Url.Action("GetSchedulesForChild", "Invoice")', { childId: childId }, function(schedules) {
                        var rows = '';
                        $.each(schedules, function(index, schedule) {
                            // Check if schedule.Program exists before accessing its properties
                            if (schedule) {
                                rows += '<tr>';
                                rows += '<td>' + (index + 1) + '</td>';
                                rows += '<td> Step ' + (schedule.prog_ID || '') + '</td>'; // Use default value if prog_name is undefined
                                rows += '<td>' + (new Date(schedule.session_datetime).toLocaleDateString() || '') + '</td>';
                                rows += '<td>' + calculateFee(schedule) + '</td>';
                                rows += '<td><button class="btn btn-primary create-invoice" data-schedule-id="' + schedule.schedule_ID + '">Create Invoice</button></td>';
                                rows += '</tr>';
                            } else {
                                console.error('schedule.Program is undefined or null for schedule:', schedule);
                            }
                        });
                        $('#scheduleTable tbody').html(rows);
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        console.error('Error fetching schedules:', textStatus, errorThrown);
                    });
                } else {
                    $('#scheduleTable tbody').html('');
                }
            });

            $('#scheduleTable').on('click', '.create-invoice', function() {
                var scheduleId = $(this).data('schedule-id');
                var childId = $('#childSelect').val();
                $.getJSON('@Url.Action("GetParentDetails", "Invoice")', { parentId: childId }, function(parent) {
                    // Populate invoice card with parent details
                    $('#invoiceCard').show();
                });
            });
        });

        $(document).ready(function() {
            $('#scheduleTable').on('click', '.create-invoice', function() {
                var scheduleId = $(this).data('schedule-id');
                var childId = $('#childSelect').val();
                $.getJSON('@Url.Action("GetParentDetails", "Invoice")', { parentId: childId }, function(parent) {
                    // Populate invoice card with parent details
                    $('#parentName').html(parent.parentName);
                    $('#parentAddress').html(parent.parentAddress);
                    $('#parentPhone').html(parent.parentPhone);
                    $('#invoiceChildId').val(childId);
                    $('#invoiceScheduleId').val(scheduleId);
                    $('#invoiceCard').show();
                });
            });
        });
    </script>
}
<style>
    .BorderLess {
        border: none;
    }
    .delete-row-btn {
        color: red;
        cursor: pointer;
    }
    .table-dashed {
        border: 1px dashed #dee2e6;
    }
    .table-dashed th,
    .table-dashed td {
        border: 1px dashed #dee2e6;
    }
</style>
<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-6">
                    <h3>Create Invoice</h3>
                </div>
                <div class="col-6">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a asp-controller="Dashboard" asp-action="Index">
                                <svg class="stroke-icon">
                                    <use href="../assets/svg/icon-sprite.svg#stroke-home"></use>
                                </svg>
                            </a>
                        </li>
                        <li class="breadcrumb-item">Billing</li>
                        <li class="breadcrumb-item">Invoices</li>
                        <li class="breadcrumb-item active">Create Invoice</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="card">
            <div class="card-header">
                Select Child and Schedule
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="childSelect">Child</label>
                    <select id="childSelect" class="form-control">
                        <option value="">Select a child</option>
                        @foreach (var child in Model)
                        {
                            <option value="@child.c_myKid">@child.c_name (@child.c_myKid)</option>
                        }
                    </select>
                </div>
            </div>
            <table class="table" id="scheduleTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Program</th>
                        <th>Session Date</th>
                        <th>Fee</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Schedule rows will be populated here by JavaScript -->
                </tbody>
            </table>
        </div>
        <div id="invoiceCard" class="card float-right mt-4" style="display:none;">
            <div class="card-header">
                Invoice
                <strong id="invoiceDate"></strong>
                <span class="float-right"><strong>Status:</strong> <span id="invoiceStatus"></span></span>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-sm-6">
                        <div style="margin-bottom: 8px;">
                            <strong>ADventure Rehabilitation Center</strong>
                        </div>
                        <div style="margin-bottom: 8px;">MA1, Kolej Tun Dr Ismail</div>
                        <div style="margin-bottom: 8px;">Skudai, 80990 Johor Bahru, Johor</div>
                        <div style="margin-bottom: 8px;">Email: info@ADventure.com.my</div>
                        <div style="margin-bottom: 8px;">Phone: +60 123 456 789</div>
                    </div>
                    <div class="col-sm-6">
                        <div class="float-right">
                            <div style="margin-bottom: 8px;">
                                <select id="parentName" class="form-control input-primary BorderLess"></select>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <select id="parentAddress" class="form-control input-primary BorderLess"></select>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <select id="parentPhone" class="form-control input-primary BorderLess"></select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-dashed">
                        <thead>
                            <tr>
                                <th class="center">#</th>
                                <th>Program</th>
                                <th>Summary</th>
                                <th>Session Date</th>
                                <th class="right">Fee</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceTableBody">
                            <tr>
                                <td class="center">1</td>
                                <td class="left strong"><textarea class="form-select" name="programs" class="form-control BorderLess" readonly></textarea></td>
                                <td class="left"><textarea name="summary" class="form-control BorderLess" readonly></textarea></td>
                                <td class="left"><textarea name="sessiondate" class="form-control BorderLess" readonly></textarea></td>
                                <td class="right"><input type="text" name="fee" class="form-control BorderLess" readonly></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="row">
                    <div class="col-lg-8 col-sm-7"></div>
                    <div class="col-lg-4 col-sm-5 ml-auto">
                        <table class="table table-clear">
                            <tbody>
                                <tr>
                                    <td class="left"><strong>Total Fee</strong></td>
                                    <td class="right"><span id="totalFee">$0.00</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <form id="createInvoiceForm" method="post" action="@Url.Action("CreateInvoice", "Invoice")">
            <input type="hidden" name="c_myKid" id="invoiceChildId" />
            <input type="hidden" name="schedule_ID" id="invoiceScheduleId" />
            <input type="hidden" name="due_date" id="invoiceDueDate" />
            <input type="hidden" name="invoice_amount" id="invoiceAmount" />
            <button type="submit" class="btn btn-primary">Submit Invoice</button>
        </form>
    </div>
</div>


