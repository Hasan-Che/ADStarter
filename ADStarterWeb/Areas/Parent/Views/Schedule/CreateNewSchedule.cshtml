@model ADStarter.Models.ViewModels.NewScheduleViewModel
@{
    ViewData["Title"] = "Create New Schedule";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="page-body">
    <div class="container-fluid">
        <div class="page-title">
            <div class="row">
                <div class="col-6">
                    <h3>Create New Schedule</h3>
                </div>
                <div class="col-6">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a asp-controller="Dashboard" asp-action="Index">
                                <svg class="stroke-icon">
                                    <use href="../assets/svg/icon-sprite.svg#stroke-home"></use>
                                </svg>
                            </a>
                        </li>
                        <li class="breadcrumb-item">Schedules</li>
                        <li class="breadcrumb-item active">Create New Schedule</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Schedule Form</h5>
                        <span>Fill out the form below to create a new schedule.</span>
                    </div>
                    <div class="card-body">
                        <form id="scheduleForm" class="needs-validation" novalidate method="post" asp-action="CreateNewSchedule">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="Child_ID">Child</label>
                                    <select class="form-select" asp-for="Child_ID" required>
                                        <option selected disabled value="">Choose...</option>
                                        @foreach (var child in ViewBag.ActiveChildren)
                                        {
                                            <option value="@child.c_myKid">@child.c_name</option>
                                        }
                                    </select>
                                    <div class="invalid-feedback">Please select a child.</div>
                                </div>
                            </div>
                            <div class="row g-3 mt-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="SessionDate">Select Date</label>
                                    <input type="date" class="form-control" id="SessionDate" name="SessionDate" asp-for="SessionDate" required>
                                    <div class="invalid-feedback">Please select a valid date.</div>
                                </div>
                            </div>
                            <div class="row g-3 mt-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="Slot_ID">Slot</label>
                                    <select class="form-select" asp-for="Slot_ID" required>
                                        <option selected disabled value="">Choose...</option>
                                        @foreach (var slot in ViewBag.SlotOptions)
                                        {
                                            <option value="@slot.slot_ID">@slot.slot_ID - @slot.slot_time</option>
                                        }
                                    </select>
                                    <div class="invalid-feedback">Please select a slot.</div>
                                </div>
                            </div>
                            <input type="hidden" id="Session_ID" name="Session_ID" asp-for="Session_ID" />
                            <div class="row g-3 mt-3">
                                <div class="col-md-6">
                                    <button class="btn btn-primary" type="submit">Submit form</button>
                                    <button type="button" class="btn btn-secondary ms-2" onclick="clearForm()">Clear form</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function clearForm() {
            document.getElementById('scheduleForm').reset();
            document.querySelectorAll('.form-control').forEach(function (element) {
                element.classList.remove('is-valid');
                element.classList.remove('is-invalid');
            });
        }

        (function () {
            'use strict';
            window.addEventListener('load', function () {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function (form) {
                    form.addEventListener('submit', function (event) {
                        var sessionDateInput = document.getElementById('SessionDate');
                        var sessionDate = new Date(sessionDateInput.value);
                        var today = new Date();
                        today.setHours(0, 0, 0, 0);
                        var tomorrow = new Date(today);
                        tomorrow.setDate(today.getDate() + 1);

                        if (sessionDate < tomorrow) {
                            sessionDateInput.setCustomValidity('Please select a date that is tomorrow or later.');
                            event.preventDefault();
                            event.stopPropagation();
                        } else {
                            sessionDateInput.setCustomValidity('');
                        }

                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });

                // Function to set Session_ID based on SessionDate
                document.getElementById('SessionDate').addEventListener('change', function () {
                    var date = new Date(document.getElementById('SessionDate').value);
                    var dayOfWeek = date.getDay(); // 0 (Sunday) to 6 (Saturday)

                    // Set session_ID: 1 for Sunday to Thursday, 2 for Friday and Saturday
                    var session_ID = (dayOfWeek === 5 || dayOfWeek === 6) ? 2 : 1;
                    document.getElementById('Session_ID').value = session_ID;
                });

                var dateInput = document.getElementById('SessionDate');
                var today = new Date();
                today.setHours(0, 0, 0, 0);
                var tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                var yyyy = tomorrow.getFullYear();
                var mm = String(tomorrow.getMonth() + 1).padStart(2, '0');
                var dd = String(tomorrow.getDate()).padStart(2, '0');
                var minDate = yyyy + '-' + mm + '-' + dd;
                dateInput.setAttribute('min', minDate);
            }, false);
        })();
    </script>
}
